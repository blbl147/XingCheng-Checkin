name: è‡ªåŠ¨ç­¾åˆ°

on:
  # å®šæ—¶è§¦å‘ï¼ˆUTCæ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´-8å°æ—¶ï¼‰
  schedule:
    # æ¯å¤© 00:00 UTC = 08:00 åŒ—äº¬æ—¶é—´
    - cron: '0 0 * * *'
    # æ¯å¤© 23:30 UTC = 07:30 åŒ—äº¬æ—¶é—´ï¼ˆå¤‡ç”¨ï¼‰
    - cron: '30 23 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æµ‹è¯•è¿è¡Œ'

# æƒé™è®¾ç½®
permissions:
  contents: read

jobs:
  checkin:
    name: æ‰§è¡Œç­¾åˆ°
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. æ‰§è¡Œç­¾åˆ°ï¼ˆä»Secretsè¯»å–ç¯å¢ƒå˜é‡ï¼‰
      - name: ğŸš€ æ‰§è¡Œç­¾åˆ°è„šæœ¬
        env:
          CHECKIN_TOKEN: ${{ secrets.CHECKIN_TOKEN }}
          ACTIVITY_CODE: ${{ secrets.ACTIVITY_CODE }}
          SHOP_CODE: ${{ secrets.SHOP_CODE }}
          SCKEY: ${{ secrets.SCKEY }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          BARK_URL: ${{ secrets.BARK_URL }}
        run: |
          python checkin.py
      
      # 5. ä¸Šä¼ æ—¥å¿—ï¼ˆå¤±è´¥æ—¶ï¼‰
      - name: ğŸ“‹ ä¸Šä¼ æ‰§è¡Œæ—¥å¿—
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: checkin-log-${{ github.run_number }}
          path: |
            *.log
          retention-days: 7
      
      # 6. é€šçŸ¥æ„å»ºç»“æœ
      - name: ğŸ“¬ é€šçŸ¥æ„å»ºçŠ¶æ€
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ç­¾åˆ°ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ ç­¾åˆ°ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
          fi

  # å¯é€‰ï¼šå¤šè´¦å·æ”¯æŒ
  checkin-multi:
    name: å¤šè´¦å·ç­¾åˆ°
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # ä»…æ‰‹åŠ¨è§¦å‘æ—¶æ‰§è¡Œ
    strategy:
      matrix:
        account: [1, 2, 3]  # æ”¯æŒæœ€å¤š3ä¸ªè´¦å·
      fail-fast: false  # ä¸€ä¸ªå¤±è´¥ä¸å½±å“å…¶ä»–è´¦å·
    
    steps:
      - uses: actions/checkout@v4
      
      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: å®‰è£…ä¾èµ–
        run: pip install -r requirements.txt
      
      - name: æ‰§è¡Œç­¾åˆ° - è´¦å·${{ matrix.account }}
        env:
          CHECKIN_TOKEN: ${{ secrets[format('CHECKIN_TOKEN_{0}', matrix.account)] }}
          ACTIVITY_CODE: ${{ secrets.ACTIVITY_CODE }}
          SHOP_CODE: ${{ secrets.SHOP_CODE }}
          SCKEY: ${{ secrets[format('SCKEY_{0}', matrix.account)] }}
        run: |
          echo "ğŸ” æ‰§è¡Œè´¦å· ${{ matrix.account }} çš„ç­¾åˆ°"
          python checkin.py
