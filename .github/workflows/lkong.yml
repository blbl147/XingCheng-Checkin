name: é¾™ç©ºè®ºå›è‡ªåŠ¨ç­¾åˆ°

on:
  # å®šæ—¶è§¦å‘ï¼ˆä½¿ç”¨UTCæ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´-8å°æ—¶ï¼‰
  schedule:
    # åŒ—äº¬æ—¶é—´ 04:00 = UTC 20:00 (å‰ä¸€å¤©)
    - cron: '0 20 * * *'
    # åŒ—äº¬æ—¶é—´ 14:00 = UTC 06:00 (å½“å¤©)
    - cron: '0 6 * * *'
  
  # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  workflow_dispatch:

jobs:
  punch:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
      
      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: ğŸ è®¾ç½®Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. è¿è¡Œç­¾åˆ°è„šæœ¬
      - name: ğŸš€ æ‰§è¡Œç­¾åˆ°
        env:
          LKONG_COOKIE: ${{ secrets.LKONG_COOKIE }}
          LKONG_REQUEST_BODY: ${{ secrets.LKONG_REQUEST_BODY }}
          TZ: Asia/Shanghai  # è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´
        run: |
          echo "å½“å‰åŒ—äº¬æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          python lkong_punch.py
      
      # 5. æäº¤çŠ¶æ€æ–‡ä»¶ï¼ˆä¿å­˜ç­¾åˆ°è®°å½•ï¼‰
      - name: ğŸ’¾ æäº¤ç­¾åˆ°çŠ¶æ€
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update punch status - $(date '+%Y-%m-%d %H:%M:%S')" && git push)
        continue-on-error: true  # å³ä½¿æäº¤å¤±è´¥ä¹Ÿä¸å½±å“ä»»åŠ¡çŠ¶æ€
      
      # 6. å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼Œå¤±è´¥æ—¶é€šçŸ¥ï¼‰
      - name: ğŸ“§ å‘é€å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ ç­¾åˆ°å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          # è¿™é‡Œå¯ä»¥æ·»åŠ å…¶ä»–é€šçŸ¥æ–¹å¼ï¼Œå¦‚é‚®ä»¶ã€Telegramç­‰
